<!DOCTYPE html>

<html>
<head>
  <title>eelnss.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="eelnss.html">
                eelnss.js
              </a>
            
              
              <a class="source" href="eetables.html">
                eetables.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>eelnss.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>eelnss.js
(c) <span class="hljs-number">20014</span>-<span class="hljs-number">2019</span> Pawel Cesar Sanjuan Szklarz
eelnss may be freely distributed under the MIT license.
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(root)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="baseline-setup-inspired-in-underscore-js">Baseline setup, inspired in underscore.js</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Establish the root object, <code>window</code> in the browser, or <code>exports</code> on the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> underscoreRef = root._ || <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="util-functions">Util functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Assertion util function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_assert</span><span class="hljs-params">(condition, message)</span> </span>{
        <span class="hljs-keyword">if</span> (!condition) {
            <span class="hljs-keyword">throw</span> message || <span class="hljs-string">"Assertion failed"</span>;
        }
    }

    <span class="hljs-keyword">var</span> lensesModule = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(_)</span> </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_defineLen</span><span class="hljs-params">(getter, setter, specification)</span> </span>{
            _assert(_.has(specification, <span class="hljs-string">"signature"</span>), <span class="hljs-string">"No signature in specification"</span>);
            _assert(_.has(specification, <span class="hljs-string">"valueSize"</span>), <span class="hljs-string">"No valueSize in specification"</span>);
            _assert(_.has(specification, <span class="hljs-string">"valueMap"</span>), <span class="hljs-string">"No valueMap in specification"</span>);
            <span class="hljs-keyword">var</span> len = {};
            len.spec = {
                signature: specification.signature,
                valueSize: specification.valueSize,
                valueMap: specification.valueMap
            };
            len.get = getter;
            len.set = setter;
            len.mod = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(f, a)</span> </span>{
                <span class="hljs-keyword">return</span> len.set(f(len.get(a)), a);
            };
            len.andThen = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(lenBC)</span> </span>{
                <span class="hljs-keyword">return</span> _andThenCompose(len, lenBC);
            };
            <span class="hljs-keyword">return</span> len;
        }


        <span class="hljs-keyword">var</span> _nilLen = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nilGetter</span><span class="hljs-params">(a)</span> </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nilSetter</span><span class="hljs-params">(b, a)</span> </span>{
                <span class="hljs-keyword">return</span> a;
            }

            <span class="hljs-keyword">return</span> _defineLen(nilGetter, nilSetter, {
                signature: <span class="hljs-string">"nil"</span>,
                valueSize: <span class="hljs-number">0</span>,
                valueMap: []
            });
        })();

        <span class="hljs-keyword">var</span> _idLen = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">idGetter</span><span class="hljs-params">(a)</span> </span>{
                <span class="hljs-keyword">return</span> a;
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">idSetter</span><span class="hljs-params">(newa, a)</span> </span>{
                <span class="hljs-keyword">return</span> newa;
            }

            <span class="hljs-keyword">return</span> _defineLen(idGetter, idSetter, {
                signature: <span class="hljs-string">"ID"</span>,
                valueSize: <span class="hljs-number">1</span>,
                valueMap: [<span class="hljs-string">"ID"</span>]
            });
        })();</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Lenses left composition
Len[A,B] ~&gt; Len[B,C] =&gt; Len[A,C]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_andThenCompose</span><span class="hljs-params">(lenAB, lenBC)</span> </span>{
            <span class="hljs-keyword">if</span> (lenAB === _idLen) {
                <span class="hljs-keyword">return</span> lenBC;
            }
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">andThenGetter</span><span class="hljs-params">(a)</span> </span>{
                <span class="hljs-keyword">return</span> lenBC.get(lenAB.get(a));
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">andThenSetter</span><span class="hljs-params">(c, a)</span> </span>{
                <span class="hljs-keyword">return</span> lenAB.mod(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(b)</span> </span>{
                    <span class="hljs-keyword">return</span> lenBC.set(c, b);
                }, a);
            }

            <span class="hljs-keyword">var</span> signature = lenAB.spec.signature + <span class="hljs-string">"."</span> + lenBC.spec.signature;
            <span class="hljs-keyword">var</span> valueSize = lenAB.spec.valueSize * lenBC.spec.valueSize;
            <span class="hljs-keyword">return</span> _defineLen(andThenGetter, andThenSetter, {
                signature: signature,
                valueSize: valueSize,
                valueMap: lenBC.spec.valueMap
            });
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_fieldLenTemplate</span><span class="hljs-params">(fieldName, fillEmpty)</span> </span>{
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fieldGetter</span><span class="hljs-params">(a)</span> </span>{
                <span class="hljs-keyword">if</span> (_.isUndefined(a)) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Arrays are not valid fieldLen containers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                _assert(!_.isArray(a), <span class="hljs-string">"Arrays are not valid fieldLen containers. Field name:"</span> + fieldName + <span class="hljs-string">". Argument:"</span> + a);
                <span class="hljs-keyword">var</span> value = a[fieldName];</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>If options.fillEmpty===true, then a empty value is filled with a {} object. This is used for nested lens zeros.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (fillEmpty === <span class="hljs-literal">true</span> &amp;&amp; _.isUndefined(value)) {
                    <span class="hljs-keyword">return</span> {};
                }
                <span class="hljs-keyword">return</span> value;
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fieldSetter</span><span class="hljs-params">(b, a)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Arrays are not valid fieldLen containers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                _assert(!_.isArray(a), <span class="hljs-string">"Arrays are not valid fieldLen containers. Field name:"</span> + fieldName + <span class="hljs-string">". Argument:"</span> + a);
                <span class="hljs-keyword">if</span> (_.isUndefined(b)) {
                    <span class="hljs-keyword">return</span> _.omit(a, fieldName);
                }
                <span class="hljs-keyword">var</span> extendO = {};
                extendO[fieldName] = b;
                <span class="hljs-keyword">return</span> _.chain(a).clone().extend(extendO).value();
            }

            <span class="hljs-keyword">return</span> _defineLen(fieldGetter, fieldSetter, {
                signature: fieldName,
                valueSize: <span class="hljs-number">1</span>,
                valueMap: [fieldName]
            });
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_fieldLenLeaf</span><span class="hljs-params">(fieldName)</span> </span>{
            <span class="hljs-keyword">return</span> _fieldLenTemplate(fieldName, <span class="hljs-literal">false</span>);
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_fieldLen</span><span class="hljs-params">(fieldName)</span> </span>{
            <span class="hljs-keyword">return</span> _fieldLenTemplate(fieldName, <span class="hljs-literal">true</span>);
        }


        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_telescopeCompose</span><span class="hljs-params">()</span> </span>{
            _assert(<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">1</span>, <span class="hljs-string">"Pass at least 2 lenses a telescope composition"</span>);
            <span class="hljs-keyword">var</span> listOfLens = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">var</span> emptyValues = _.range(listOfLens.length).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
            });

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">telescopeGetter</span><span class="hljs-params">(a)</span> </span>{
                <span class="hljs-keyword">return</span> _.map(listOfLens, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(singleCLen)</span> </span>{
                    <span class="hljs-keyword">return</span> singleCLen.get(a);
                });
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">telescopeSetter</span><span class="hljs-params">(b, a)</span> </span>{
                <span class="hljs-keyword">var</span> values = b;
                <span class="hljs-keyword">if</span> (_.isUndefined(values)) {
                    values = emptyValues;
                }
                <span class="hljs-keyword">return</span> _.reduce(_.zip(listOfLens, values), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(finalA, len_value)</span> </span>{
                    <span class="hljs-keyword">var</span> len = len_value[<span class="hljs-number">0</span>];
                    <span class="hljs-keyword">var</span> value = len_value[<span class="hljs-number">1</span>];
                    <span class="hljs-keyword">return</span> len.set(value, finalA);
                }, a);
            }

            <span class="hljs-keyword">var</span> telescopeSignature = _.reduce(listOfLens, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(accum, len, index)</span> </span>{
                    <span class="hljs-keyword">if</span> (index === listOfLens.length - <span class="hljs-number">1</span>) {
                        <span class="hljs-keyword">return</span> accum + len.spec.signature;
                    }
                    <span class="hljs-keyword">return</span> accum + len.spec.signature + <span class="hljs-string">","</span>;
                }, <span class="hljs-string">"("</span>) + <span class="hljs-string">")"</span>;
            <span class="hljs-keyword">var</span> telescopeValueMap = _.chain(listOfLens).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(len)</span> </span>{
                <span class="hljs-keyword">return</span> len.spec.valueMap;
            }).flatten(<span class="hljs-literal">true</span>).value();

            <span class="hljs-keyword">return</span> _defineLen(telescopeGetter, telescopeSetter, {
                signature: telescopeSignature,
                valueSize: listOfLens.length,
                valueMap: telescopeValueMap
            });
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_buildLenFromNestedFieldsExpression</span><span class="hljs-params">(nestedFieldsExpression)</span> </span>{
            <span class="hljs-keyword">var</span> listOfFields = nestedFieldsExpression.split(<span class="hljs-string">"."</span>);
            <span class="hljs-keyword">return</span> _.chain(listOfFields)
                .map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fieldName, index)</span> </span>{
                    <span class="hljs-keyword">var</span> isLast = ((listOfFields.length - index - <span class="hljs-number">1</span>) === <span class="hljs-number">0</span> );
                    <span class="hljs-keyword">if</span> (isLast) {
                        <span class="hljs-keyword">return</span> _fieldLenLeaf(fieldName);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">return</span> _fieldLen(fieldName);
                    }
                })
                .reduce(_andThenCompose, _idLen)
                .value();
        }


        <span class="hljs-keyword">return</span> {
            defineLen: _defineLen,
            nilLen: _nilLen,
            idLen: _idLen,
            fieldLenLeaf: _fieldLenLeaf,
            fieldLen: _fieldLen,
            telescopeCompose: _telescopeCompose,
            andThenCompose: _andThenCompose,
            nestedFieldBuilder: _buildLenFromNestedFieldsExpression
        };
    })(underscoreRef);

    <span class="hljs-keyword">var</span> booleanFunctionsModule = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_andComposition</span><span class="hljs-params">(elements)</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(state)</span> </span>{
                <span class="hljs-keyword">return</span> _.every(elements, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(testSubFunction)</span> </span>{
                    <span class="hljs-keyword">return</span> testSubFunction(state);
                });
            };
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_orComposition</span><span class="hljs-params">(elements)</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(state)</span> </span>{
                <span class="hljs-keyword">return</span> _.some(elements, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(testSubFunction)</span> </span>{
                    <span class="hljs-keyword">return</span> testSubFunction(state);
                });
            };
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_buildBooleanCheckerForArrayValue</span><span class="hljs-params">(expectedValue, indexInArray)</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(stateAsArray)</span> </span>{
                <span class="hljs-keyword">return</span> stateAsArray[indexInArray] === expectedValue;
            };
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Build a Array =&gt; bool function.
arrayNamesSpecification is a map {columnName -&gt; indexInArray }
queryObject encode a list of boolean criteria.
AND case: each key is a columnName and value is not an object
OR case: there is a key that contains a object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_arrayBooleanFromQueryObject</span><span class="hljs-params">(arrayNamesSpecification, queryObject)</span> </span>{
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_buildSingleCriteria</span><span class="hljs-params">(value, indexNumber)</span> </span>{
                <span class="hljs-keyword">if</span> (_.isObject(value)) {
                    <span class="hljs-keyword">return</span> _arrayBooleanFromQueryObject(arrayNamesSpecification, value);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> _buildBooleanCheckerForArrayValue(value, indexNumber);
                }
            }

            <span class="hljs-keyword">var</span> isOr = _.chain(queryObject).values().some(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
                <span class="hljs-keyword">return</span> _.isObject(value);
            }).value();
            <span class="hljs-keyword">var</span> singleCriteria = _.chain(queryObject).keys().map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
                <span class="hljs-keyword">var</span> value = queryObject[key];
                <span class="hljs-keyword">var</span> indexValue = arrayNamesSpecification[key];
                <span class="hljs-keyword">return</span> _buildSingleCriteria(value, indexValue);
            }).value();
            <span class="hljs-keyword">if</span> (isOr) {
                <span class="hljs-keyword">return</span> _orComposition(singleCriteria);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> _andComposition(singleCriteria);
            }
        }

        <span class="hljs-keyword">return</span> {
            buildCriteria: _arrayBooleanFromQueryObject
        };

    })(underscoreRef);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Context is a single value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> contextLensesModule = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(_, lenses, booleanFunctions)</span> </span>{
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_defineContextLen</span><span class="hljs-params">(contextGetter, contextSetter, contextExtractor, specification)</span> </span>{
            _assert(_.has(specification, <span class="hljs-string">"contextSize"</span>), <span class="hljs-string">"No contextSize in specification"</span>);
            _assert(_.has(specification, <span class="hljs-string">"valueSize"</span>), <span class="hljs-string">"No valueSize in specification"</span>);
            _assert(_.has(specification, <span class="hljs-string">"signature"</span>), <span class="hljs-string">"No signature in specification"</span>);
            _assert(_.has(specification, <span class="hljs-string">"pointers"</span>), <span class="hljs-string">"No pointers in specification"</span>);
            _assert(_.has(specification, <span class="hljs-string">"contextMap"</span>), <span class="hljs-string">"No contextMap in specification"</span>);
            _assert(_.has(specification, <span class="hljs-string">"valueMap"</span>), <span class="hljs-string">"No valueMap in specification"</span>);
            <span class="hljs-keyword">var</span> opt = specification || {};
            <span class="hljs-keyword">var</span> clen = {};
            clen.spec = {
                contextSize: opt.contextSize,
                valueSize: opt.valueSize,
                signature: opt.signature,
                pointers: opt.pointers,
                contextMap: opt.contextMap,
                valueMap: opt.valueMap,
                selfPointer: opt.selfPointer
            };
            <span class="hljs-keyword">if</span> (clen.spec.selfPointer) {
                clen.spec.pointers[clen.spec.selfPointer] = clen;
            }
            clen.spec.size = clen.spec.contextSize + clen.spec.valueSize;
            clen.cget = contextGetter;
            clen.cset = contextSetter;
            clen.extract = contextExtractor;
            clen.cmod = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(context, f, a)</span> </span>{
                <span class="hljs-keyword">return</span> clen.cset(context, f(clen.cget(context, a)), a);
            };
            <span class="hljs-keyword">if</span> (clen.spec.contextSize === <span class="hljs-number">0</span>) {
                clen.lget = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(container)</span> </span>{
                    <span class="hljs-keyword">var</span> contextWithValue;
                    <span class="hljs-keyword">if</span> (clen.spec.valueSize === <span class="hljs-number">1</span>) {
                        contextWithValue = [clen.cget([], container)];
                    } <span class="hljs-keyword">else</span> {
                        contextWithValue = clen.cget([], container);
                    }
                    <span class="hljs-keyword">return</span> [contextWithValue];
                };

            } <span class="hljs-keyword">else</span> {
                clen.lget = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(container)</span> </span>{
                    <span class="hljs-keyword">return</span> _listContextGetter(clen, container);
                };
            }
            clen.lset = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(listContextValue, container)</span> </span>{
                <span class="hljs-keyword">if</span> (_.isUndefined(listContextValue) || listContextValue.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> clen.cset([], <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>), container);
                }
                <span class="hljs-keyword">return</span> _listContextSetter(clen, listContextValue, container);
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>The bind operation just fix the context parameter and return a len.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            clen.bindContext = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(context)</span> </span>{
                _assert(context.length === clen.spec.contextSize, <span class="hljs-string">"context size error"</span>);
                <span class="hljs-keyword">var</span> bindedGet = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a)</span> </span>{
                    <span class="hljs-keyword">return</span> clen.cget(context, a);
                };
                <span class="hljs-keyword">var</span> bindedSet = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(b, a)</span> </span>{
                    <span class="hljs-keyword">return</span> clen.cset(context, b, a);
                };
                <span class="hljs-keyword">return</span> lenses.defineLen(bindedGet, bindedSet, {
                    signature: clen.spec.signature,
                    valueSize: clen.spec.valueSize,
                    valueMap: clen.spec.valueMap
                });
            };
            clen.bindContextValue = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(contextAndValue)</span> </span>{
                _assert(contextAndValue.length === clen.spec.size, <span class="hljs-string">"context size error"</span>);
                <span class="hljs-keyword">var</span> _context = contextAndValue.slice(<span class="hljs-number">0</span>, clen.spec.contextSize);
                <span class="hljs-keyword">var</span> _value = contextAndValue.slice(clen.spec.contextSize);
                <span class="hljs-keyword">var</span> _len = clen.bindContext(_context);
                <span class="hljs-keyword">return</span> {
                    len: _len,
                    value: _value,
                    context: _context
                };
            };
            clen.find = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(queryCriteria)</span> </span>{
                <span class="hljs-keyword">var</span> arrayColumns = clen.spec.contextMap.concat(clen.spec.valueMap);
                <span class="hljs-keyword">var</span> arraySpec = _.chain(arrayColumns).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(spec, colName, index)</span> </span>{
                    spec[colName] = index;
                    <span class="hljs-keyword">return</span> spec;
                }, {}).value();
                <span class="hljs-keyword">var</span> criteria = booleanFunctions.buildCriteria(arraySpec, queryCriteria);
                <span class="hljs-keyword">return</span> {
                    on: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(state)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>TODO use internal iterators and make a fast filter for nested lenses</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">return</span> _.chain(clen.lget(state)).filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arrayValues)</span> </span>{
                            <span class="hljs-keyword">return</span> criteria(arrayValues);
                        }).value();
                    }
                };
            };
            <span class="hljs-keyword">return</span> clen;
        }


        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_listContextGetter</span><span class="hljs-params">(cLen, container)</span> </span>{
            <span class="hljs-keyword">return</span> _.chain(cLen.extract(container)).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(context)</span> </span>{
                <span class="hljs-keyword">return</span> context.concat(cLen.cget(context, container));
            }).value();
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_listContextSetter</span><span class="hljs-params">(cLen, listContextValue, container)</span> </span>{
            <span class="hljs-keyword">return</span> _.chain(listContextValue)
                .reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(currContainer, contextAndValue)</span> </span>{
                    <span class="hljs-keyword">var</span> context = contextAndValue.slice(<span class="hljs-number">0</span>, cLen.spec.contextSize);
                    <span class="hljs-keyword">var</span> value = contextAndValue.slice(cLen.spec.contextSize);
                    <span class="hljs-keyword">if</span> (cLen.spec.valueSize === <span class="hljs-number">1</span>) {
                        <span class="hljs-keyword">return</span> cLen.cset(context, value[<span class="hljs-number">0</span>], currContainer);
                    }
                    <span class="hljs-keyword">return</span> cLen.cset(context, value, currContainer);
                }, container).value();
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_emptyExtractor</span><span class="hljs-params">(a)</span> </span>{
            <span class="hljs-keyword">return</span> [
                []
            ];
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_contextLenFromLen</span><span class="hljs-params">(len)</span> </span>{
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cgetFromLen</span><span class="hljs-params">(context, a)</span> </span>{
                <span class="hljs-keyword">return</span> len.get(a);
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">csetFromLen</span><span class="hljs-params">(context, b, a)</span> </span>{
                <span class="hljs-keyword">return</span> len.set(b, a);
            }

            <span class="hljs-keyword">return</span> _defineContextLen(cgetFromLen, csetFromLen, _emptyExtractor, {
                    contextSize: <span class="hljs-number">0</span>,
                    valueSize: len.spec.valueSize,
                    signature: len.spec.signature,
                    pointers: {},
                    contextMap: [],
                    valueMap: len.spec.valueMap,
                    selfPointer: len.spec.signature
                }
            );
        }

        <span class="hljs-keyword">var</span> _idContextLen = _contextLenFromLen(lenses.idLen);

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_mapContextLenTemplate</span><span class="hljs-params">(fillEmpty)</span> </span>{

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cgetMap</span><span class="hljs-params">(context, a)</span> </span>{
                _assert(_.isArray(context), <span class="hljs-string">"context for map must be a single value"</span>);
                <span class="hljs-keyword">if</span> (fillEmpty &amp;&amp; context.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> {};
                }
                _assert(context.length === <span class="hljs-number">1</span>, <span class="hljs-string">"context for map must be a single value"</span>);
                <span class="hljs-keyword">var</span> key = context[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">var</span> value = a[key];
                <span class="hljs-keyword">if</span> (fillEmpty &amp;&amp; _.isUndefined(value)) {
                    <span class="hljs-keyword">return</span> {};
                }
                <span class="hljs-keyword">return</span> value;
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">csetMap</span><span class="hljs-params">(context, b, a)</span> </span>{
                _assert(_.isArray(context), <span class="hljs-string">"context for map must be a single value"</span>);
                <span class="hljs-keyword">if</span> (context.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> a;
                }
                _assert(context.length === <span class="hljs-number">1</span>, <span class="hljs-string">"context for map must be a single value"</span>);
                <span class="hljs-keyword">var</span> key = context[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">if</span> (_.isUndefined(b)) {
                    <span class="hljs-keyword">return</span> _.omit(a, key);
                }
                <span class="hljs-keyword">var</span> extendO = {};
                extendO[key] = b;
                <span class="hljs-keyword">return</span> _.chain(a).clone().extend(extendO).value();
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">contextExtractorMap</span><span class="hljs-params">(a)</span> </span>{
                <span class="hljs-keyword">var</span> keys = _.keys(a);
                <span class="hljs-keyword">if</span> (keys.length === <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> [];
                }
                <span class="hljs-keyword">return</span> _.chain(keys).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
                    <span class="hljs-keyword">return</span> [key];
                }).value();
            }

            <span class="hljs-keyword">return</span> _defineContextLen(cgetMap, csetMap, contextExtractorMap, {
                    contextSize: <span class="hljs-number">1</span>,
                    valueSize: <span class="hljs-number">1</span>,
                    signature: <span class="hljs-string">"{:map}"</span>,
                    pointers: {},
                    contextMap: [<span class="hljs-string">"map"</span>],
                    valueMap: [<span class="hljs-string">"_"</span>],
                    selfPointer: <span class="hljs-literal">undefined</span>
                }
            );
        }

        <span class="hljs-keyword">var</span> _mapContextLenLeaf = _mapContextLenTemplate(<span class="hljs-literal">false</span>);
        <span class="hljs-keyword">var</span> _mapContextLen = _mapContextLenTemplate(<span class="hljs-literal">true</span>);

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_contextAndThenComposition</span><span class="hljs-params">(cLenAB, cLenBC)</span> </span>{
            <span class="hljs-keyword">if</span> (cLenAB === _idContextLen) {
                <span class="hljs-keyword">return</span> cLenBC;
            }
            <span class="hljs-keyword">if</span> (cLenBC === _idContextLen) {
                <span class="hljs-keyword">return</span> cLenAB;
            }
            <span class="hljs-keyword">var</span> cAndThenSignature = cLenAB.spec.signature + <span class="hljs-string">"."</span> + cLenBC.spec.signature;
            <span class="hljs-keyword">var</span> cAndThenContextSize = cLenAB.spec.contextSize + cLenBC.spec.contextSize;
            <span class="hljs-keyword">var</span> cAndThenValueSize = cLenAB.spec.valueSize * cLenBC.spec.valueSize;
            <span class="hljs-keyword">var</span> cAndThenPartialPoints = _.extend(cLenAB.spec.pointers, cLenBC.spec.pointers);
            <span class="hljs-keyword">var</span> selfPointer;
            <span class="hljs-keyword">if</span> (cLenAB.spec.selfPointer &amp;&amp; cLenBC.spec.selfPointer) {
                selfPointer = cLenAB.spec.selfPointer + <span class="hljs-string">'.'</span> + cLenBC.spec.selfPointer;
            }
            <span class="hljs-keyword">var</span> cAndThenSpecification = {
                contextSize: cAndThenContextSize,
                valueSize: cAndThenValueSize,
                signature: cAndThenSignature,
                pointers: cAndThenPartialPoints,
                contextMap: cLenAB.spec.contextMap.concat(cLenBC.spec.contextMap),
                valueMap: cLenBC.spec.valueMap,
                selfPointer: selfPointer
            };

            <span class="hljs-keyword">if</span> (cLenAB.spec.contextSize === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> simpleAndThen();
            }
            <span class="hljs-keyword">if</span> (cLenBC.spec.contextSize === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> simpleInverseAndThen();
            }
            <span class="hljs-keyword">return</span> realCAndThen();

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">simpleAndThen</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">var</span> simpleCget = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(context, a)</span> </span>{
                    <span class="hljs-keyword">return</span> cLenBC.cget(context, cLenAB.cget([], a));
                };
                <span class="hljs-keyword">var</span> simpleCset = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(context, c, a)</span> </span>{
                    <span class="hljs-keyword">return</span> cLenAB.cmod([], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(b)</span> </span>{
                        <span class="hljs-keyword">return</span> cLenBC.cset(context, c, b);
                    }, a);
                };
                <span class="hljs-keyword">var</span> simpleExtract = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a)</span> </span>{
                    <span class="hljs-keyword">return</span> cLenBC.extract(cLenAB.cget([], a));
                };
                <span class="hljs-keyword">return</span> _defineContextLen(simpleCget, simpleCset, simpleExtract, cAndThenSpecification);
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">simpleInverseAndThen</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">var</span> simpleCget = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(context, a)</span> </span>{
                    <span class="hljs-keyword">return</span> cLenBC.cget([], cLenAB.cget(context, a));
                };
                <span class="hljs-keyword">var</span> simpleCset = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(context, c, a)</span> </span>{
                    <span class="hljs-keyword">return</span> cLenAB.cmod(context, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(b)</span> </span>{
                        <span class="hljs-keyword">return</span> cLenBC.cset([], c, b);
                    }, a);
                };
                <span class="hljs-keyword">return</span> _defineContextLen(simpleCget, simpleCset, cLenAB.extract, cAndThenSpecification);
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">realCAndThen</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">var</span> composedCget = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(context, a)</span> </span>{
                    <span class="hljs-keyword">var</span> ABcontext = context.slice(<span class="hljs-number">0</span>, cLenAB.spec.contextSize);
                    <span class="hljs-keyword">var</span> BCcontext = context.slice(cLenAB.spec.contextSize);
                    <span class="hljs-keyword">return</span> cLenBC.cget(BCcontext, cLenAB.cget(ABcontext, a));
                };
                <span class="hljs-keyword">var</span> composedCset = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(context, c, a)</span> </span>{
                    <span class="hljs-keyword">var</span> ABcontext = context.slice(<span class="hljs-number">0</span>, cLenAB.spec.contextSize);
                    <span class="hljs-keyword">var</span> BCcontext = context.slice(cLenAB.spec.contextSize);
                    <span class="hljs-keyword">return</span> cLenAB.cmod(ABcontext, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(b)</span> </span>{
                        <span class="hljs-keyword">return</span> cLenBC.cset(BCcontext, c, b);
                    }, a);
                };
                <span class="hljs-keyword">var</span> composedExtactor = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a)</span> </span>{
                    <span class="hljs-keyword">return</span> _.chain(cLenAB.extract(a)).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(single_b_context)</span> </span>{
                        <span class="hljs-keyword">var</span> b = cLenAB.cget(single_b_context, a);
                        <span class="hljs-keyword">return</span> _.map(cLenBC.extract(b), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(single_c_context)</span> </span>{
                            <span class="hljs-keyword">return</span> single_b_context.concat(single_c_context);
                        });
                    }).flatten(<span class="hljs-literal">true</span>).value();
                };
                <span class="hljs-keyword">return</span> _defineContextLen(composedCget, composedCset, composedExtactor, cAndThenSpecification);
            }
        }


        <span class="hljs-keyword">return</span> {
            defineContextLen: _defineContextLen,
            idContextLen: _idContextLen,
            mapContextLenLeaf: _mapContextLenLeaf,
            mapContextLen: _mapContextLen,
            contextLenFromLen: _contextLenFromLen,
            contextLenComposition: _contextAndThenComposition
        };
    })(underscoreRef, lensesModule, booleanFunctionsModule);

    <span class="hljs-keyword">var</span> publicApiModule = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(_, lenses, contextLenses)</span> </span>{

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_buildNestedContextLen</span><span class="hljs-params">(contextLenExpressionRaw)</span> </span>{

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">telescopePartBuilder</span><span class="hljs-params">(part, last)</span> </span>{
                _assert(last === <span class="hljs-literal">true</span>, <span class="hljs-string">" telescope parts must be at the end of the context len expression"</span>);
                <span class="hljs-keyword">var</span> setParams = (<span class="hljs-regexp">/\((.*)\)/gi</span>).exec(part)[<span class="hljs-number">1</span>];
                <span class="hljs-keyword">var</span> telescopeLensDefinitions = setParams.length === <span class="hljs-number">0</span> ? [] : setParams.split(<span class="hljs-string">","</span>);

                <span class="hljs-keyword">var</span> listOfLens = _.map(telescopeLensDefinitions, lenses.nestedFieldBuilder);
                <span class="hljs-keyword">return</span> contextLenses.contextLenFromLen(lenses.telescopeCompose.apply({}, listOfLens));
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fieldPartBuilder</span><span class="hljs-params">(part, last)</span> </span>{
                <span class="hljs-keyword">if</span> (last) {
                    <span class="hljs-keyword">return</span> contextLenses.contextLenFromLen(lenses.fieldLenLeaf(part));
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> contextLenses.contextLenFromLen(lenses.fieldLen(part));
                }
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mapPartBuilder</span><span class="hljs-params">(part, last)</span> </span>{
                <span class="hljs-keyword">var</span> mapcLen;
                <span class="hljs-keyword">if</span> (last) {
                    mapcLen = contextLenses.mapContextLenLeaf;
                } <span class="hljs-keyword">else</span> {
                    mapcLen = _.clone(contextLenses.mapContextLen);
                }
                mapcLen.pointers = {};
                mapcLen.pointers[part] = mapcLen;
                mapcLen.spec = _.clone(mapcLen.spec);
                mapcLen.spec.selfPointer = part;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>{:anyName} -&gt; anyName</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                mapcLen.spec.contextMap = [part.substr(<span class="hljs-number">2</span>, part.length - <span class="hljs-number">3</span>)];
                mapcLen.spec.signature = part;
                <span class="hljs-keyword">return</span> mapcLen;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>clear white spaces</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> contextLenExpression = contextLenExpressionRaw.replace(<span class="hljs-regexp">/ /g</span>, <span class="hljs-string">''</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Extract final telescope expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> telescopeSeparator = contextLenExpression.indexOf(<span class="hljs-string">"("</span>);
            <span class="hljs-keyword">var</span> parts;
            <span class="hljs-keyword">switch</span> (telescopeSeparator) {
                <span class="hljs-keyword">case</span> -<span class="hljs-number">1</span>:
                    parts = contextLenExpression.split(<span class="hljs-string">"."</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
                    parts = [contextLenExpression];
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>expression is a.b.c.(telescope) -&gt; split to a.b.c (telescope)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> contextParts = contextLenExpression.substring(<span class="hljs-number">0</span>, telescopeSeparator - <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">var</span> telescopePart = contextLenExpression.substring(telescopeSeparator);
                    parts = contextParts.split(<span class="hljs-string">"."</span>);
                    parts.push(telescopePart);
            }
            <span class="hljs-keyword">var</span> cLenInstance = _.chain(parts).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(part, index)</span> </span>{
                <span class="hljs-keyword">var</span> type = part.charAt(<span class="hljs-number">0</span>);
                <span class="hljs-keyword">var</span> isLast = ((parts.length - index - <span class="hljs-number">1</span>) === <span class="hljs-number">0</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Switch to the different part builders.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">switch</span> (type) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">'('</span>:
                        <span class="hljs-keyword">return</span> telescopePartBuilder(part, isLast);
                    <span class="hljs-keyword">case</span> <span class="hljs-string">'{'</span>:
                        <span class="hljs-keyword">return</span> mapPartBuilder(part, isLast);
                    <span class="hljs-keyword">default</span> :
                        <span class="hljs-keyword">return</span> fieldPartBuilder(part, isLast);
                }
            }).reduce(contextLenses.contextLenComposition, contextLenses.idContextLen).value();
            cLenInstance.signature = contextLenExpression;
            <span class="hljs-keyword">return</span> cLenInstance;
        }


        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_crossProduct</span><span class="hljs-params">()</span> </span>{
            _assert(<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">1</span>, <span class="hljs-string">"Pass at least 2 clens to build a cross product"</span>);
            <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
            <span class="hljs-keyword">var</span> head = args[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">var</span> tail = _.tail(args);
            <span class="hljs-keyword">return</span> _.reduce(tail, crossProductComposition, head);
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">crossProductComposition</span><span class="hljs-params">(Aclen, Bclen)</span> </span>{
            <span class="hljs-keyword">var</span> crossContextSize = Aclen.spec.contextSize + Bclen.spec.contextSize;
            <span class="hljs-keyword">var</span> crossValueSize = Aclen.spec.valueSize + Bclen.spec.valueSize;
            <span class="hljs-keyword">var</span> crossProductSignature = Aclen.spec.signature + <span class="hljs-string">" X "</span> + Bclen.spec.signature;
            <span class="hljs-keyword">var</span> crossProductSpecification = {
                contextSize: crossContextSize,
                valueSize: crossValueSize,
                signature: crossProductSignature,
                pointers: {},
                contextMap: Aclen.spec.contextMap.concat(Bclen.spec.contextMap),
                valueMap: Aclen.spec.valueMap.concat(Bclen.spec.valueMap),
                selfPointer: <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>)
            };

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">crossCget</span><span class="hljs-params">(context, a)</span> </span>{
                <span class="hljs-keyword">var</span> Acontext = context.slice(<span class="hljs-number">0</span>, Aclen.spec.contextSize);
                <span class="hljs-keyword">var</span> Bcontext = context.slice(Aclen.spec.contextSize);
                <span class="hljs-keyword">var</span> AValues = Aclen.cget(Acontext, a);
                <span class="hljs-keyword">var</span> BValues = Bclen.cget(Bcontext, a);
                <span class="hljs-keyword">if</span> (Aclen.spec.valueSize === <span class="hljs-number">1</span>) {
                    AValues = [AValues];
                }
                <span class="hljs-keyword">if</span> (Bclen.spec.valueSize === <span class="hljs-number">1</span>) {
                    BValues = [BValues];
                }
                <span class="hljs-keyword">return</span> AValues.concat(BValues);
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">crossCset</span><span class="hljs-params">(context, c, a)</span> </span>{
                <span class="hljs-keyword">if</span> (_.isUndefined(c)) {
                    c = _.range(crossValueSize).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span>(<span class="hljs-number">0</span>);
                    });
                }
                <span class="hljs-keyword">var</span> Acontext = context.slice(<span class="hljs-number">0</span>, Aclen.spec.contextSize);
                <span class="hljs-keyword">var</span> Bcontext = context.slice(Aclen.spec.contextSize);
                <span class="hljs-keyword">var</span> Avalue = c.slice(<span class="hljs-number">0</span>, Aclen.spec.valueSize);
                <span class="hljs-keyword">var</span> Bvalue = c.slice(Aclen.spec.valueSize);
                <span class="hljs-keyword">if</span> (Aclen.spec.valueSize === <span class="hljs-number">1</span>) {
                    Avalue = Avalue[<span class="hljs-number">0</span>];
                }
                <span class="hljs-keyword">if</span> (Bclen.spec.valueSize === <span class="hljs-number">1</span>) {
                    Bvalue = Bvalue[<span class="hljs-number">0</span>];
                }
                <span class="hljs-keyword">var</span> afterA = Aclen.cset(Acontext, Avalue, a);
                <span class="hljs-keyword">var</span> afterB = Bclen.cset(Bcontext, Bvalue, afterA);
                <span class="hljs-keyword">return</span> afterB;
            }

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">crossExtactor</span><span class="hljs-params">(a)</span> </span>{
                <span class="hljs-keyword">var</span> Acontexts = Aclen.extract(a);
                <span class="hljs-keyword">var</span> Bcontexts = Bclen.extract(a);
                <span class="hljs-keyword">return</span> _.chain(Acontexts).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(aContextSingle)</span> </span>{
                    <span class="hljs-keyword">return</span> _.chain(Bcontexts).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(bContextSingle)</span> </span>{
                        <span class="hljs-keyword">return</span> _.flatten([aContextSingle, bContextSingle], <span class="hljs-literal">true</span>);
                    }).value();
                }).flatten(<span class="hljs-literal">true</span>).value();
            }

            <span class="hljs-keyword">var</span> finalCross = contextLenses.defineContextLen(crossCget, crossCset, crossExtactor, crossProductSpecification);
            finalCross.signature = crossProductSignature;
            <span class="hljs-keyword">return</span> finalCross;
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_buildLen</span><span class="hljs-params">(lenExpression)</span> </span>{
            <span class="hljs-keyword">var</span> contextLen = _buildNestedContextLen(lenExpression);
            <span class="hljs-keyword">if</span> (contextLen.spec.contextSize &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-string">"Len expression contains a context parameter: "</span> + lenExpression;
            }
            <span class="hljs-keyword">return</span> contextLen.bindContext([]);
        }


        <span class="hljs-keyword">return</span> {
            buildLen: _buildLen,
            buildContextLen: _buildNestedContextLen,
            crossProduct: _crossProduct
        };

    })(underscoreRef, lensesModule, contextLensesModule);

    root.eelnss = {
        lenses: lensesModule,
        contextLenses: contextLensesModule,
        api: publicApiModule
    };
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {
        define(<span class="hljs-string">'eelnss'</span>, [<span class="hljs-string">'underscore'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(_)</span> </span>{
            <span class="hljs-keyword">return</span> eelnss;
        });
    }

})(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
