//     eelnss.js
//     (c) 20014-2019 Pawel Cesar Sanjuan Szklarz
//     eelnss may be freely distributed under the MIT license.
!function(e){function t(e,t){if(!e)throw t||"Assertion failed"}var n=e._||require("underscore"),r=function(e){function n(n,i){t(e.isFunction(n),"pullFunctionBuilder is not a function, bad use od table iterator api");var c=function(){var c={};return c.spec={contextSize:i.length,contextValueSizes:i,extractionPoints:r(i)},c.nestedNext=n(),t(e.isFunction(c.nestedNext),"nestedNext is not a function, bad use od table iterator api"),c.loopOver=function(e){for(var t=c.nestedNext();t!==void 0;){var n=t[0],r=t[1],i=t[2];e(n,r,i),t=c.nestedNext()}},c};return c.spec={contextSize:i.length,contextValueSizes:i,extractionPoints:r(i)},c}//          |        |     |     |
function r(t){var n=t.length;return e.reduce(t,function(t,n){var r=e.last(t);return t.push(r+n),t},[n])}function i(e,t){for(var n=t.length,r=n,i=0;n>i;i++)if(e[i]!==t[i]){r=i;break}return r}function c(e,t){function c(){var e=t(),n=void 0;return function(){var t=e.next();if(t===void 0)return void 0;var r,c=t.slice(0,u);if(n===void 0){var a=t.slice(u);r=[0,c,a]}else{var s=i(n,c),l=c.slice(s),f=t.slice(o[s]);r=[s,l,f]}return n=c,r}}var u=e.length,o=r(e);return n(c,e)}function u(e,t){var n=t.length,r=function(){var e=0;return{next:function(){return n===e?void 0:t[e++]}}};return c(e,r)}function o(t){var n,r,i=[],c=e.map(t.spec.extractionPoints,function(e){return e-t.spec.contextSize}),u=function(t,u,o){if(0===t)n=u,r=o;else{var a=c[t];n=e.first(n,t).concat(u),r=e.first(r,a).concat(o)}i.push(n.concat(r))};return t.loopOver(u),i}function a(){function n(e,t){var n=e.spec.contextValueSizes,r=t.spec.contextValueSizes,i=function(){function n(){}function r(){return a=u.nestedNext(),s=o.nestedNext(),a===void 0||s===void 0?(l=!0,void(f=n)):void(f=c)}function i(){return a=u.nestedNext(),a===void 0?(l=!0,void(f=n)):(o=t(),void(s=o.nestedNext()))}function c(){s=o.nestedNext(),s===void 0&&i()}var u=e(),o=t(),a=void 0,s=void 0,l=!1,f=r;return{next:function(){return f(),l?void 0:a[1].concat(s[1],a[2],s[2])}}};return c(n.concat(r),i)}t(arguments.length>1,"Pass at least 2 table iterators to build a cross product");var r=Array.prototype.slice.call(arguments),i=r[0],u=e.tail(r);return e.reduce(u,n,i)}function s(n,r){function i(t,n){var r=t[0],i=t[1],c=i.length,u=n[0],o=n[1],a=o.length;return e.chain(r).map(function(t){return e.chain(u).map(function(n){var r=e.first(t,c).concat(e.first(n,a)),i=t.slice(c).concat(n.slice(a));return r.concat(i)}).value()}).flatten(!0).value()}t(n.length>1,"Pass at least 2 table iterators to build a cross product"),t(r.length===n.length,"Provide context sizes for each table");var c=e.zip(n,r),u=c[0],o=e.tail(c);return e.reduce(o,i,u)}return{tableIterator:n,tableIteratorFromTable:u,tableIteratorBuilder:c,buildTableFromIterator:o,crossProductTableIterators:a,crossProductTables:s}}(n),i=function(e){function n(e,t,n){var i=n||{},c={};return c.spec={signature:i.signature||"not provided",valueSize:i.valueSize||1},c.get=e,c.set=t,c.mod=function(e,t){return c.set(e(c.get(t)),t)},c.andThen=function(e){return r(c,e)},c}function r(e,t){function r(n){return t.get(e.get(n))}function i(n,r){return e.mod(function(e){return t.set(n,e)},r)}if(e===l)return t;var c=e.spec.signature+"."+t.spec.signature,u=e.spec.valueSize*t.spec.valueSize;return n(r,i,{signature:c,valueSize:u})}function i(r,i){function c(n){if(e.isUndefined(n))return void 0;t(!e.isArray(n),"Arrays are not valid fieldLen containers. Field name:"+r+". Argument:"+n);var c=n[r];return i===!0&&e.isUndefined(c)?{}:c}function u(n,i){if(t(!e.isArray(i),"Arrays are not valid fieldLen containers. Field name:"+r+". Argument:"+i),e.isUndefined(n))return e.omit(i,r);var c={};return c[r]=n,e.chain(i).clone().extend(c).value()}return n(c,u,r)}function c(e){return i(e,!1)}function u(e){return i(e,!0)}function o(){function r(t){return e.map(c,function(e){return e.get(t)})}function i(t,n){var r=t;return e.isUndefined(r)&&(r=u),e.reduce(e.zip(c,r),function(e,t){var n=t[0],r=t[1];return n.set(r,e)},n)}t(arguments.length>1,"Pass at least 2 lenses a telescope composition");var c=Array.prototype.slice.call(arguments),u=e.range(c.length).map(function(){return void 0}),o=e.reduce(c,function(e,t){return e+t.spec.signature+","},"(")+")";return n(r,i,{signature:o,valueSize:c.length})}function a(t){var n=t.split(".");return e.chain(n).map(function(e,t){var r=n.length-t-1===0;return r?c(e):u(e)}).reduce(r,l).value()}var s=function(){function e(){return void 0}function t(e,t){return t}return n(e,t,{signature:"nil",valueSize:0})}(),l=function(){function e(e){return e}function t(e){return e}return n(e,t,{signature:"ID",valueSize:1})}();return{defineLen:n,nilLen:s,idLen:l,fieldLenLeaf:c,fieldLen:u,telescopeCompose:o,andThenCompose:r,nestedFieldBuilder:a}}(n),c=function(e,n){function r(e,r,u,o){var a=o||{},s={};return s.spec={contextSize:a.contextSize||0,valueSize:a.valueSize||1,signature:a.signature||"not provider"},s.spec.size=s.spec.contextSize+s.spec.valueSize,s.cget=e,s.cset=r,s.extract=u,s.cmod=function(e,t,n){return s.cset(e,t(s.cget(e,n)),n)},0==s.spec.contextSize?(s.lget=function(e){var t;return t=1===s.spec.valueSize?[s.cget([],e)]:s.cget([],e),[t]},s.lset=function(e,t){return 0===e.length?s.cset([],void 0,t):c(s,e,t)}):(s.lget=function(e){return i(s,e)},s.lset=function(e,t){return c(s,e,t)}),s.bindContext=function(e){t(e.length===s.spec.contextSize,"context size error");var r=function(t){return s.cget(e,t)},i=function(t,n){return s.cset(e,t,n)};return n.defineLen(r,i,{signature:s.spec.signature,valueSize:s.spec.valueSize})},s.bindContextValue=function(e){t(e.length===s.spec.size,"context size error");var n=e.slice(0,s.spec.contextSize),r=e.slice(s.spec.contextSize),i=s.bindContext(n);return{len:i,value:r,context:n}},s}function i(t,n){return e.chain(t.extract(n)).map(function(e){return e.concat(t.cget(e,n))}).value()}function c(t,n,r){return e.chain(n).reduce(function(e,n){var r=n.slice(0,t.spec.contextSize),i=n.slice(t.spec.contextSize);return 1===t.spec.valueSize?t.cset(r,i[0],e):t.cset(r,i,e)},r).value()}function u(){return[[]]}function o(e){function t(t,n){return e.get(n)}function n(t,n,r){return e.set(n,r)}return r(t,n,u,{contextSize:0,valueSize:e.spec.valueSize,signature:e.spec.signature})}function a(n){function i(r,i){t(e.isArray(r),"context for map must be a single value"),t(1===r.length,"context for map must be a single value");var c=r[0],u=i[c];return n&&e.isUndefined(u)?{}:u}function c(n,r,i){t(e.isArray(n),"context for map must be a single value"),t(1===n.length,"context for map must be a single value");var c=n[0];return i[c]=r,i}function u(t){var n=e.keys(t);return 0===n.length?[]:e.chain(n).map(function(e){return[e]}).value()}return r(i,c,u,{contextSize:1,valueSize:1,signature:"{:map}"})}function s(t,n){function i(){var e=function(e,r){return n.cget(e,t.cget([],r))},i=function(e,r,i){return t.cmod([],function(t){return n.cset(e,r,t)},i)},c=function(e){return n.extract(t.cget([],e))};return r(e,i,c,f)}function c(){var e=function(e,r){return n.cget([],t.cget(e,r))},i=function(e,r,i){return t.cmod(e,function(e){return n.cset([],r,e)},i)};return r(e,i,t.extract,f)}function u(){var i=function(e,r){var i=e.slice(0,t.spec.contextSize),c=e.slice(t.spec.contextSize);return n.cget(c,t.cget(i,r))},c=function(e,r,i){var c=e.slice(0,t.spec.contextSize),u=e.slice(t.spec.contextSize);return t.cmod(c,function(e){return n.cset(u,r,e)},i)},u=function(r){return e.chain(t.extract(r)).map(function(i){var c=t.cget(i,r);return e.map(n.extract(c),function(e){return i.concat(e)})}).flatten(!0).value()};return r(i,c,u,f)}if(t===l)return n;var o=t.spec.signature+" cAndThen "+n.spec.signature,a=t.spec.contextSize+n.spec.contextSize,s=t.spec.valueSize*n.spec.valueSize,f={contextSize:a,valueSize:s,signature:o};return 0===t.spec.contextSize?i():0===n.spec.contextSize?c():u()}var l=o(n.idLen),f=a(!1),v=a(!0);return{defineContextLen:r,idContextLen:l,mapContextLenLeaf:f,mapContextLen:v,contextLenFromLen:o,contextLenComposition:s}}(n,i),u=function(e,n,r){function i(i){function c(i,c){t(c===!0," telescope parts must be at the end of the context len expression");var u=/\((.*)\)/gi.exec(i)[1],o=0===u.length?[]:u.split(","),a=e.map(o,n.nestedFieldBuilder);return r.contextLenFromLen(n.telescopeCompose.apply({},a))}function u(e,t){return r.contextLenFromLen(t?n.fieldLenLeaf(e):n.fieldLen(e))}function o(e,t){return t?r.mapContextLenLeaf:r.mapContextLen}var a,s=i.replace(/ /g,""),l=s.indexOf("(");switch(l){case-1:a=s.split(".");break;case 0:a=[s];break;default:var f=s.substring(0,l-1),v=s.substring(l);a=f.split("."),a.push(v)}var p=e.chain(a).map(function(e,t){var n=e.charAt(0),r=a.length-t-1===0;switch(n){case"(":return c(e,r);case"{":return o(e,r);default:return u(e,r)}}).reduce(r.contextLenComposition,r.idContextLen).value();return p.signature=s,p}function c(){t(arguments.length>1,"Pass at least 2 clens to build a cross product");var n=Array.prototype.slice.call(arguments),r=n[0],i=e.tail(n);return e.reduce(i,u,r)}function u(t,n){function i(e,r){var i=e.slice(0,t.spec.contextSize),c=e.slice(t.spec.contextSize),u=t.cget(i,r),o=n.cget(c,r);return 1===t.spec.valueSize&&(u=[u]),1===n.spec.valueSize&&(o=[o]),u.concat(o)}function c(r,i,c){e.isUndefined(i)&&(i=e.range(a).map(function(){return void 0}));var u=r.slice(0,t.spec.contextSize),o=r.slice(t.spec.contextSize),s=i.slice(0,t.spec.valueSize),l=i.slice(t.spec.valueSize);1===t.spec.valueSize&&(s=s[0]),1===n.spec.valueSize&&(l=l[0]);var f=t.cset(u,s,c),v=n.cset(o,l,f);return v}function u(r){var i=t.extract(r),c=n.extract(r);return e.chain(i).map(function(t){return e.chain(c).map(function(n){return e.flatten([t,n],!0)}).value()}).flatten(!0).value()}var o=t.spec.contextSize+n.spec.contextSize,a=t.spec.valueSize+n.spec.valueSize,s=t.spec.signature+" X "+n.spec.signature,l={contextSize:o,valueSize:a,signature:s},f=r.defineContextLen(i,c,u,l);return f.signature=s,f}return{buildContextLen:i,crossProduct:c}}(n,i,c);e.eelnss={lenses:i,contextLenses:c,tableIterators:r,api:u}}(this);
//# sourceMappingURL=eelnss-min.map