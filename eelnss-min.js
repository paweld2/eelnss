//     eelnss.js
//     (c) 20014-2019 Pawel Cesar Sanjuan Szklarz
//     eelnss may be freely distributed under the MIT license.
!function(e){function n(e,n){if(!e)throw n||"Assertion failed"}var t=e._||require("underscore"),r=function(e){function t(t,i){n(e.isFunction(t),"pullFunctionBuilder is not a function, bad use od table iterator api");var c=function(){var c={};return c.spec={contextSize:i.length,contextValueSizes:i,extractionPoints:r(i)},c.nestedNext=t(),n(e.isFunction(c.nestedNext),"nestedNext is not a function, bad use od table iterator api"),c.loopOver=function(e){for(var n=c.nestedNext();n!==void 0;){var t=n[0],r=n[1],i=n[2];e(t,r,i),n=c.nestedNext()}},c};return c.spec={contextSize:i.length,contextValueSizes:i,extractionPoints:r(i)},c}//          |        |     |     |
function r(n){var t=n.length;return e.reduce(n,function(n,t){var r=e.last(n);return n.push(r+t),n},[t])}function i(e,n){for(var t=n.length,r=t,i=0;t>i;i++)if(e[i]!==n[i]){r=i;break}return r}function c(e,n){function c(){var e=n(),t=void 0;return function(){var n=e.next();if(n===void 0)return void 0;var r,c=n.slice(0,u);if(t===void 0){var o=n.slice(u);r=[0,c,o]}else{var s=i(t,c),l=c.slice(s),f=n.slice(a[s]);r=[s,l,f]}return t=c,r}}var u=e.length,a=r(e);return t(c,e)}function u(e,n){var t=n.length,r=function(){var e=0;return{next:function(){return t===e?void 0:n[e++]}}};return c(e,r)}function a(n){var t,r,i=[],c=e.map(n.spec.extractionPoints,function(e){return e-n.spec.contextSize}),u=function(n,u,a){if(0===n)t=u,r=a;else{var o=c[n];t=e.first(t,n).concat(u),r=e.first(r,o).concat(a)}i.push(t.concat(r))};return n.loopOver(u),i}function o(){function t(e,n){var t=e.spec.contextValueSizes,r=n.spec.contextValueSizes,i=function(){function t(){}function r(){return o=u.nestedNext(),s=a.nestedNext(),o===void 0||s===void 0?(l=!0,void(f=t)):void(f=c)}function i(){return o=u.nestedNext(),o===void 0?(l=!0,void(f=t)):(a=n(),void(s=a.nestedNext()))}function c(){s=a.nestedNext(),s===void 0&&i()}var u=e(),a=n(),o=void 0,s=void 0,l=!1,f=r;return{next:function(){return f(),l?void 0:o[1].concat(s[1],o[2],s[2])}}};return c(t.concat(r),i)}n(arguments.length>1,"Pass at least 2 table iterators to build a cross product");var r=Array.prototype.slice.call(arguments),i=r[0],u=e.tail(r);return e.reduce(u,t,i)}function s(t,r){function i(n,t){var r=n[0],i=n[1],c=i.length,u=t[0],a=t[1],o=a.length;return e.chain(r).map(function(n){return e.chain(u).map(function(t){var r=e.first(n,c).concat(e.first(t,o)),i=n.slice(c).concat(t.slice(o));return r.concat(i)}).value()}).flatten(!0).value()}n(t.length>1,"Pass at least 2 table iterators to build a cross product"),n(r.length===t.length,"Provide context sizes for each table");var c=e.zip(t,r),u=c[0],a=e.tail(c);return e.reduce(a,i,u)}return{tableIterator:t,tableIteratorFromTable:u,tableIteratorBuilder:c,buildTableFromIterator:a,crossProductTableIterators:o,crossProductTables:s}}(t),i=function(e){function t(t,i,c){n(e.has(c,"signature"),"No signature in specification"),n(e.has(c,"valueSize"),"No valueSize in specification"),n(e.has(c,"valueMap"),"No valueMap in specification");var u={};return u.spec={signature:c.signature,valueSize:c.valueSize,valueMap:c.valueMap},u.get=t,u.set=i,u.mod=function(e,n){return u.set(e(u.get(n)),n)},u.andThen=function(e){return r(u,e)},u}function r(e,n){function r(t){return n.get(e.get(t))}function i(t,r){return e.mod(function(e){return n.set(t,e)},r)}if(e===l)return n;var c=e.spec.signature+"."+n.spec.signature,u=e.spec.valueSize*n.spec.valueSize;return t(r,i,{signature:c,valueSize:u,valueMap:n.spec.valueMap})}function i(r,i){function c(t){if(e.isUndefined(t))return void 0;n(!e.isArray(t),"Arrays are not valid fieldLen containers. Field name:"+r+". Argument:"+t);var c=t[r];return i===!0&&e.isUndefined(c)?{}:c}function u(t,i){if(n(!e.isArray(i),"Arrays are not valid fieldLen containers. Field name:"+r+". Argument:"+i),e.isUndefined(t))return e.omit(i,r);var c={};return c[r]=t,e.chain(i).clone().extend(c).value()}return t(c,u,{signature:r,valueSize:1,valueMap:[r]})}function c(e){return i(e,!1)}function u(e){return i(e,!0)}function a(){function r(n){return e.map(c,function(e){return e.get(n)})}function i(n,t){var r=n;return e.isUndefined(r)&&(r=u),e.reduce(e.zip(c,r),function(e,n){var t=n[0],r=n[1];return t.set(r,e)},t)}n(arguments.length>1,"Pass at least 2 lenses a telescope composition");var c=Array.prototype.slice.call(arguments),u=e.range(c.length).map(function(){return void 0}),a=e.reduce(c,function(e,n,t){return t===c.length-1?e+n.spec.signature:e+n.spec.signature+","},"(")+")",o=e.chain(c).map(function(e){return e.spec.valueMap}).flatten(!0).value();return t(r,i,{signature:a,valueSize:c.length,valueMap:o})}function o(n){var t=n.split(".");return e.chain(t).map(function(e,n){var r=t.length-n-1===0;return r?c(e):u(e)}).reduce(r,l).value()}var s=function(){function e(){return void 0}function n(e,n){return n}return t(e,n,{signature:"nil",valueSize:0,valueMap:[]})}(),l=function(){function e(e){return e}function n(e){return e}return t(e,n,{signature:"ID",valueSize:1,valueMap:["ID"]})}();return{defineLen:t,nilLen:s,idLen:l,fieldLenLeaf:c,fieldLen:u,telescopeCompose:a,andThenCompose:r,nestedFieldBuilder:o}}(t),c=function(){function e(e){return function(n){return _.every(e,function(e){return e(n)})}}function n(e){return function(n){return _.some(e,function(e){return e(n)})}}function t(e,n){return function(t){return t[n]===e}}function r(i,c){function u(e,n){return _.isObject(e)?r(i,e):t(e,n)}var a=_.chain(c).values().some(function(e){return _.isObject(e)}).value(),o=_.chain(c).keys().map(function(e){var n=c[e],t=i[e];return u(n,t)}).value();return a?n(o):e(o)}return{buildCriteria:r}}(t),u=function(e,t,r){function i(i,a,o,s){n(e.has(s,"contextSize"),"No contextSize in specification"),n(e.has(s,"valueSize"),"No valueSize in specification"),n(e.has(s,"signature"),"No signature in specification"),n(e.has(s,"pointers"),"No pointers in specification"),n(e.has(s,"contextMap"),"No contextMap in specification"),n(e.has(s,"valueMap"),"No valueMap in specification");var l=s||{},f={};return f.spec={contextSize:l.contextSize,valueSize:l.valueSize,signature:l.signature,pointers:l.pointers,contextMap:l.contextMap,valueMap:l.valueMap,selfPointer:l.selfPointer},f.spec.selfPointer&&(f.spec.pointers[f.spec.selfPointer]=f),f.spec.size=f.spec.contextSize+f.spec.valueSize,f.cget=i,f.cset=a,f.extract=o,f.cmod=function(e,n,t){return f.cset(e,n(f.cget(e,t)),t)},f.lget=0===f.spec.contextSize?function(e){var n;return n=1===f.spec.valueSize?[f.cget([],e)]:f.cget([],e),[n]}:function(e){return c(f,e)},f.lset=function(n,t){return e.isUndefined(n)||0===n.length?f.cset([],void 0,t):u(f,n,t)},f.bindContext=function(e){n(e.length===f.spec.contextSize,"context size error");var r=function(n){return f.cget(e,n)},i=function(n,t){return f.cset(e,n,t)};return t.defineLen(r,i,{signature:f.spec.signature,valueSize:f.spec.valueSize,valueMap:f.spec.valueMap})},f.bindContextValue=function(e){n(e.length===f.spec.size,"context size error");var t=e.slice(0,f.spec.contextSize),r=e.slice(f.spec.contextSize),i=f.bindContext(t);return{len:i,value:r,context:t}},f.find=function(n){var t=f.spec.contextMap.concat(f.spec.valueMap),i=e.chain(t).reduce(function(e,n,t){return e[n]=t,e},{}).value(),c=r.buildCriteria(i,n);return{on:function(n){return e.chain(f.lget(n)).filter(function(e){return c(e)}).value()}}},f}function c(n,t){return e.chain(n.extract(t)).map(function(e){return e.concat(n.cget(e,t))}).value()}function u(n,t,r){return e.chain(t).reduce(function(e,t){var r=t.slice(0,n.spec.contextSize),i=t.slice(n.spec.contextSize);return 1===n.spec.valueSize?n.cset(r,i[0],e):n.cset(r,i,e)},r).value()}function a(){return[[]]}function o(e){function n(n,t){return e.get(t)}function t(n,t,r){return e.set(t,r)}return i(n,t,a,{contextSize:0,valueSize:e.spec.valueSize,signature:e.spec.signature,pointers:{},contextMap:[],valueMap:e.spec.valueMap,selfPointer:e.spec.signature})}function s(t){function r(r,i){if(n(e.isArray(r),"context for map must be a single value"),t&&0===r.length)return{};n(1===r.length,"context for map must be a single value");var c=r[0],u=i[c];return t&&e.isUndefined(u)?{}:u}function c(t,r,i){if(n(e.isArray(t),"context for map must be a single value"),0===t.length)return i;n(1===t.length,"context for map must be a single value");var c=t[0];if(e.isUndefined(r))return e.omit(i,c);var u={};return u[c]=r,e.chain(i).clone().extend(u).value()}function u(n){var t=e.keys(n);return 0===t.length?[]:e.chain(t).map(function(e){return[e]}).value()}return i(r,c,u,{contextSize:1,valueSize:1,signature:"{:map}",pointers:{},contextMap:["map"],valueMap:["_"],selfPointer:void 0})}function l(n,t){function r(){var e=function(e,r){return t.cget(e,n.cget([],r))},r=function(e,r,i){return n.cmod([],function(n){return t.cset(e,r,n)},i)},c=function(e){return t.extract(n.cget([],e))};return i(e,r,c,v)}function c(){var e=function(e,r){return t.cget([],n.cget(e,r))},r=function(e,r,i){return n.cmod(e,function(e){return t.cset([],r,e)},i)};return i(e,r,n.extract,v)}function u(){var r=function(e,r){var i=e.slice(0,n.spec.contextSize),c=e.slice(n.spec.contextSize);return t.cget(c,n.cget(i,r))},c=function(e,r,i){var c=e.slice(0,n.spec.contextSize),u=e.slice(n.spec.contextSize);return n.cmod(c,function(e){return t.cset(u,r,e)},i)},u=function(r){return e.chain(n.extract(r)).map(function(i){var c=n.cget(i,r);return e.map(t.extract(c),function(e){return i.concat(e)})}).flatten(!0).value()};return i(r,c,u,v)}if(n===f)return t;if(t===f)return n;var a,o=n.spec.signature+"."+t.spec.signature,s=n.spec.contextSize+t.spec.contextSize,l=n.spec.valueSize*t.spec.valueSize,p=e.extend(n.spec.pointers,t.spec.pointers);n.spec.selfPointer&&t.spec.selfPointer&&(a=n.spec.selfPointer+"."+t.spec.selfPointer);var v={contextSize:s,valueSize:l,signature:o,pointers:p,contextMap:n.spec.contextMap.concat(t.spec.contextMap),valueMap:t.spec.valueMap,selfPointer:a};return 0===n.spec.contextSize?r():0===t.spec.contextSize?c():u()}var f=o(t.idLen),p=s(!1),v=s(!0);return{defineContextLen:i,idContextLen:f,mapContextLenLeaf:p,mapContextLen:v,contextLenFromLen:o,contextLenComposition:l}}(t,i,c),a=function(e,t,r){function i(i){function c(i,c){n(c===!0," telescope parts must be at the end of the context len expression");var u=/\((.*)\)/gi.exec(i)[1],a=0===u.length?[]:u.split(","),o=e.map(a,t.nestedFieldBuilder);return r.contextLenFromLen(t.telescopeCompose.apply({},o))}function u(e,n){return r.contextLenFromLen(n?t.fieldLenLeaf(e):t.fieldLen(e))}function a(n,t){var i;return i=t?r.mapContextLenLeaf:e.clone(r.mapContextLen),i.pointers={},i.pointers[n]=i,i.spec=e.clone(i.spec),i.spec.selfPointer=n,i.spec.contextMap=[n.substr(2,n.length-3)],i.spec.signature=n,i}var o,s=i.replace(/ /g,""),l=s.indexOf("(");switch(l){case-1:o=s.split(".");break;case 0:o=[s];break;default:var f=s.substring(0,l-1),p=s.substring(l);o=f.split("."),o.push(p)}var v=e.chain(o).map(function(e,n){var t=e.charAt(0),r=o.length-n-1===0;switch(t){case"(":return c(e,r);case"{":return a(e,r);default:return u(e,r)}}).reduce(r.contextLenComposition,r.idContextLen).value();return v.signature=s,v}function c(){n(arguments.length>1,"Pass at least 2 clens to build a cross product");var t=Array.prototype.slice.call(arguments),r=t[0],i=e.tail(t);return e.reduce(i,u,r)}function u(n,t){function i(e,r){var i=e.slice(0,n.spec.contextSize),c=e.slice(n.spec.contextSize),u=n.cget(i,r),a=t.cget(c,r);return 1===n.spec.valueSize&&(u=[u]),1===t.spec.valueSize&&(a=[a]),u.concat(a)}function c(r,i,c){e.isUndefined(i)&&(i=e.range(o).map(function(){return void 0}));var u=r.slice(0,n.spec.contextSize),a=r.slice(n.spec.contextSize),s=i.slice(0,n.spec.valueSize),l=i.slice(n.spec.valueSize);1===n.spec.valueSize&&(s=s[0]),1===t.spec.valueSize&&(l=l[0]);var f=n.cset(u,s,c),p=t.cset(a,l,f);return p}function u(r){var i=n.extract(r),c=t.extract(r);return e.chain(i).map(function(n){return e.chain(c).map(function(t){return e.flatten([n,t],!0)}).value()}).flatten(!0).value()}var a=n.spec.contextSize+t.spec.contextSize,o=n.spec.valueSize+t.spec.valueSize,s=n.spec.signature+" X "+t.spec.signature,l={contextSize:a,valueSize:o,signature:s,pointers:{},contextMap:n.spec.contextMap.concat(t.spec.contextMap),valueMap:n.spec.valueMap.concat(t.spec.valueMap),selfPointer:void 0},f=r.defineContextLen(i,c,u,l);return f.signature=s,f}return{buildContextLen:i,crossProduct:c}}(t,i,u);e.eelnss={lenses:i,contextLenses:u,tableIterators:r,api:a},"function"==typeof define&&define.amd&&define("eelnss",["underscore"],function(){return eelnss})}(this);
//# sourceMappingURL=eelnss-min.map